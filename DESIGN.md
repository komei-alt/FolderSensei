# FolderSensei - AI駆動フォルダ自動整理アプリ 設計書

## 概要

指定したFinderフォルダを常時監視し、AIとOCRを活用してファイルを自動分類・整理する
macOSネイティブアプリ。監視中のフォルダにはFinder上でバッジアイコンを表示する。

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    FolderSensei.app                      │
│  ┌───────────────┐  ┌────────────────┐  ┌────────────┐  │
│  │  SwiftUI GUI  │  │  MenuBar Agent │  │  Settings   │  │
│  └──────┬────────┘  └───────┬────────┘  └─────┬──────┘  │
│         └──────────┬────────┘                  │         │
│              ┌─────▼─────┐                     │         │
│              │ AppState  │◄────────────────────┘         │
│              └─────┬─────┘                               │
│         ┌──────────▼──────────┐                          │
│         │  OrganizingEngine   │                          │
│         │  (パイプライン統括)  │                          │
│         └──┬───┬───┬───┬─────┘                           │
│            │   │   │   │                                 │
│   ┌───────▼┐ ┌▼───▼┐ ┌▼──────────┐  ┌───────────────┐  │
│   │Folder  │ │OCR  │ │AI         │  │File           │  │
│   │Watcher │ │     │ │Classifier │  │Organizer      │  │
│   │        │ │     │ │           │  │(移動/リネーム) │  │
│   │FSEvents│ │Vision│ │Ollama/   │  │               │  │
│   │API     │ │+PDF  │ │OpenAI API│  │               │  │
│   └────────┘ └─────┘ └──────────┘  └───────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │              XPC Service (IPC)                   │    │
│  └──────────────────────┬──────────────────────────┘    │
└─────────────────────────┼───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│           FinderSyncExtension.appex                      │
│  ┌────────────────────────────────────────────────────┐  │
│  │  FIFinderSync subclass                             │  │
│  │  - バッジアイコン表示 (監視中/整理中/完了)         │  │
│  │  - 右クリックメニュー (監視開始/停止/設定)         │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

## 技術スタック

| 機能                | 技術                                        |
|---------------------|---------------------------------------------|
| フォルダ監視        | FSEvents API (再帰的・効率的)               |
| OCR                 | Vision.framework VNRecognizeTextRequest rev3 |
| PDF テキスト抽出    | PDFKit + Vision.framework                   |
| AI 分類             | Ollama (ローカル) / OpenAI API (クラウド)   |
| Finder バッジ       | FinderSync Extension (FIFinderSync)         |
| IPC                 | XPC Service / Distributed Notifications     |
| GUI                 | SwiftUI + AppKit                            |
| データ永続化        | SwiftData                                   |
| バックグラウンド動作 | launchd / Login Items                       |

## OCR パイプライン詳細

```
ファイル検出
    │
    ├── 画像ファイル (.png, .jpg, .heic, .tiff, .webp)
    │   └── VNRecognizeTextRequest (accurate レベル)
    │       ├── recognitionLevel: .accurate
    │       ├── recognitionLanguages: ["ja", "en", ...]
    │       ├── usesLanguageCorrection: true
    │       └── revision: VNRecognizeTextRequestRevision3
    │
    ├── PDF ファイル
    │   ├── 1. PDFKit でテキストレイヤー抽出
    │   └── 2. テキストが空 → 各ページを CGImage 化 → Vision OCR
    │
    ├── スキャン画像 (低品質検出時)
    │   ├── CIFilter で前処理 (コントラスト強化, ノイズ除去)
    │   └── → Vision OCR
    │
    └── その他 (.doc, .xlsx, .txt)
        └── NSWorkspace / Quick Look でテキスト抽出
```

### OCR精度向上の工夫

1. **前処理パイプライン**: CIFilter でコントラスト強化・二値化・傾き補正
2. **認識レベル**: `.accurate` を使用 (`.fast` より高精度)
3. **言語指定**: ユーザー設定で認識対象言語を指定可能
4. **言語補正**: `usesLanguageCorrection = true` で辞書ベース補正
5. **信頼度フィルタ**: `confidence` 閾値以下の結果を除外
6. **複数パス**: 低信頼度の場合、前処理を変えて再OCR

## AI 分類パイプライン

```
OCR/メタデータ取得結果
    │
    ▼
プロンプト構築
    │  ユーザー定義のプロンプトテンプレート:
    │  「以下のファイル情報に基づいて、最適なフォルダ名を提案してください。
    │   ファイル名: {filename}
    │   拡張子: {extension}
    │   作成日: {created_date}
    │   OCRテキスト: {ocr_text}
    │   ファイルサイズ: {size}
    │
    │   仕分けルール: {user_prompt}
    │
    │   JSON形式で回答: {"folder": "...", "reason": "..."}」
    │
    ▼
AI 推論
    ├── ローカル (Ollama): llama3.2-vision / gemma2 等
    └── クラウド (OpenAI API): gpt-4o-mini 等
    │
    ▼
結果パース & 実行
    ├── 提案されたフォルダが存在しなければ作成
    ├── ファイルを移動 (FileManager.moveItem)
    └── 操作ログを記録 (Undo対応)
```

## Finder バッジ仕様

| 状態         | バッジ                     | 説明                           |
|-------------|---------------------------|-------------------------------|
| 監視中       | 🟢 緑の目アイコン          | フォルダが監視対象として有効    |
| 整理実行中   | 🔄 青の回転アイコン        | ファイルの分析・移動を実行中    |
| 一時停止     | ⏸ 黄色のポーズアイコン     | ユーザーが監視を一時停止中      |
| エラー       | ⚠️ 赤の警告アイコン        | 処理中にエラーが発生            |

## ユーザーフロー

1. アプリ起動 → メニューバーに常駐
2. 「フォルダを追加」→ Finderで対象フォルダを選択
3. プロンプト/ルールを設定:
   - 例: 「請求書はinvoices/、契約書はcontracts/、写真はphotos/YYYY-MM/に振り分けて」
   - 例: 「ファイル名に日付があれば年月フォルダに整理」
4. 監視開始 → Finderのフォルダにバッジが表示される
5. 新しいファイルが追加されると:
   - OCRでテキスト抽出
   - AIが分類先を決定
   - 自動でファイルを移動
   - 通知で結果を表示
6. 操作履歴から Undo 可能

## 対応要件

- macOS 14.0 (Sonoma) 以降
- Apple Silicon / Intel 両対応
- Vision.framework rev3 (日本語OCR対応)
